"use strict";var AcrSelectionUtils={isFlagContainsOnlySpecialChar:function(a){var b=/\w/g;return!b.test(a)},replaceRangeContent:function(a,b){a.deleteContents(),a.insertNode(a.createContextualFragment(b))},getTextContent:function(a){var b=$("<div/>").html(a);return b.text().replace(/\t+/g,"")},escapeRegExp:function(a){return a.replace(/([\".*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},createSearchPattern:function(a,b){var c=a[0].textContent,d="\\b";return AcrSelectionUtils.shouldApplyWordBoundary(a,b)===!0&&(c=d+c+d),c},shouldApplyWordBoundary:function(a,b){var c,d,e,f,g,h,i=a[a.length-1].range[1];return d=AcrSelectionUtils.getFlagContents(i,i+1,b),f=a[0].textContent.split(/\\s+/),g=f[0],e=g.substr(0,1),h=g,f.length>1&&(h=f[1]),c=h.substr(h.length-1,1),h.indexOf("&")>-1&&h.indexOf(";")>-1&&h.indexOf(";")>h.indexOf("&")?!1:g.indexOf("&")>-1&&g.indexOf(";")>-1&&g.indexOf(";")>g.indexOf("&")?!1:AcrSelectionUtils.isAlphaNumeral(e)&&AcrSelectionUtils.isAlphaNumeral(c)&&AcrSelectionUtils.isAlphaNumeral(d)&&45!==c.charCodeAt(0)&&!AcrSelectionUtils.isFlagContainsOnlySpecialChar(a[0].htmlContent)?!0:!1},isAlphaNumeral:function(a){return a.charCodeAt(0)>=48&&a.charCodeAt(0)<=90||a.charCodeAt(0)>=97&&a.charCodeAt(0)<=126?!0:!1},getFlagContents:function(a,b,c){return c.substr(a,b-a)},addPropertiesToMatches:function(a,b){var c,d,e,f,g,h=a[0].range[0],i=a[a.length-1].range[1];return d=AcrSelectionUtils.getFlagContents(0,h,b),e=AcrSelectionUtils.getTextContent(d),a[0].textOffset=e.length,0===a[0].textOffset&&(f=/<([a-zA-Z][a-zA-Z0-9]*)\b[^>]*/gm,null!==(g=f.exec(d))&&(h=a[0].textOffset+g.input.length)),a[0].htmlContent=AcrSelectionUtils.getFlagContents(h,i,b),c=AcrSelectionUtils.getTextContent(a[0].htmlContent),c=AcrSelectionUtils.escapeRegExp(c),a[0].textContent=c,a[0].searchPattern=AcrSelectionUtils.createSearchPattern(a,b),a},findBestMatchOffset:function(a,b){var c=-1,d=b[0].textOffset;if(a.length>0){c=0;for(var e=Math.abs(a[c]-d),f=0;f<a.length;f++)Math.abs(a[f]-d)<e&&(c=f,e=Math.abs(a[c]-d))}return c},findAllFlagOffsets:function(a,b){var c,d,e=[];d=new RegExp(b,"gm");for(var f=null;null!==(c=d.exec(a));){var g=c.index;if(f===g)break;f=g,e.push(g)}return e}},CKEditorAdapter=function(){var a=function(a){this.config=a,this.editorId=a.editorId,this.editor=null};return a.prototype={getEditor:function(){return null===this.editor&&CKEDITOR.instances.hasOwnProperty(this.editorId)&&(this.editor=CKEDITOR.instances[this.editorId]),this.editor},getEditorDocument:function(){try{return this.getEditor().document.$}catch(a){throw a}},getEditableElement:function(){return this.editor.editable().$},getCurrentText:function(){try{return rangy.innerText(this.getEditorDocument())}catch(a){throw a}},getHTML:function(){return this.getEditor().getData()},createRange:function(a,b){var c=this.getEditableElement(),d=rangy.createRange(this.getEditorDocument());return d.setStart(c,0),d.setEnd(c,0),d.moveStart("character",a),d.moveEnd("character",b),d},selectText:function(a,b){var c=this.createRange(a,b),d=rangy.getSelection(this.getEditorDocument());return d.setSingleRange(c),c},scrollAndSelect:function(a){var b,c,d,e,f,g,h;if(b=a[0].foundOffset,c=a[0].flagLength+1,f=this.selectText(b,c),d=this.getEditor().getSelection())try{d.scrollIntoView()}catch(i){}return h=this.getEditorDocument(),e=rangy.getSelection(h),g=rangy.createRange(h),g.setStart(f.startContainer,f.startOffset),g.setEnd(f.endContainer,f.endOffset),e.setSingleRange(g),g},extractHTMLForCheck:function(){if(this.html=this.getHTML(),this.currentHtmlChecking=this.html,"wysiwyg"===this.editor.mode)this.checkStartTime=Date.now(),""===this.html&&(this.html="<span> </span>");else{if(!this.isCheckingNow)return{error:"Action is not permitted in Source mode."};this.isCheckingNow=!1}return{html:this.html}},registerCheckCall:function(a){},registerCheckResult:function(a){return this.isCheckingNow=!1,this.currentHtmlChecking=this.html,this.prevCheckedHtml=this.currentHtmlChecking,[]},selectRanges:function(a,b){"wysiwyg"===this.editor.mode?this.selectMatches(a,b):window.alert("Action is not permitted in Source mode.")},selectMatches:function(a,b){var c,d,e,f=this.getCurrentText();if(b=AcrSelectionUtils.addPropertiesToMatches(b,this.currentHtmlChecking),c=AcrSelectionUtils.findAllFlagOffsets(f,b[0].searchPattern),d=AcrSelectionUtils.findBestMatchOffset(c,b),e=c[d],b[0].foundOffset=e,b[0].content.length>=b[0].range[1]-b[0].range[0]?b[0].textContent=b[0].textContent.replace(/\\/g,""):b[0].textContent=b[0].textContent.replace(/\\\\/g,"\\"),b[0].flagLength=b[0].textContent.length-1,!(e>=0))throw"Selected flagged content is modified.";this.scrollAndSelect(b)},replaceRanges:function(a,b){var c,d,e=1;if("wysiwyg"===this.editor.mode){try{this.selectMatches(a,b),b[0].foundOffset+b[0].flagLength<this.getCurrentText().length&&(b[0].foundOffset+=e,b[0].flagLength-=e),d=this.scrollAndSelect(b)}catch(f){return void console.log(f)}c=_.map(b,"replacement").join(""),AcrSelectionUtils.replaceRangeContent(d,c),b[0].foundOffset+b[0].flagLength<this.getCurrentText().length&&(e>0&&(this.selectText(b[0].foundOffset-e,e),rangy.getSelection(this.getEditorDocument()).nativeSelection.deleteFromDocument()),b[0].foundOffset-=e,b[0].flagLength+=e),this.selectText(b[0].foundOffset,c.length)}else window.alert("Action is not permitted in Source mode.")}},a}(),InputAdapter=function(){var a=function(a){void 0!==a.editorId?this.element=document.getElementById(a.editorId):this.element=a};return a.prototype={getHTML:function(){return $(this.element).val()},getEditorDocument:function(){try{return this.element.ownerDocument}catch(a){throw a}},getCurrentText:function(){try{return this.getHTML()}catch(a){throw a}},extractHTMLForCheck:function(){return this.html=this.getHTML(),this.currentHtmlChecking=this.html,{html:this.html}},registerCheckResult:function(a){return[]},registerCheckCall:function(a){},selectText:function(a,b){var c=this.getEditorDocument(),d=rangy.getSelection(c),e=rangy.createRange(c);return e.setStart(this.element,0),e.moveStart("character",a),e.moveEnd("character",b),d.setSingleRange(e),e},scrollIntoView2:function(a){var b=a.getRangeAt(0),c=b.cloneRange();c.collapse();var d=document.createElement("span");c.startContainer.parentNode.insertBefore(d,c.startContainer),d.scrollIntoView(),d.remove()},scrollAndSelect:function(a){var b,c;b=a[0].foundOffset,c=a[0].flagLength+1,$(this.element).focus(),$(this.element).setSelection(b,b+c),$(this.element)[0].scrollIntoView();var d=$("#wp-content-editor-container");d.length>0&&window.scrollBy(0,-50)},selectRanges:function(a,b){this.selectMatches(a,b)},selectMatches:function(a,b){var c,d,e,f=this.getCurrentText();if(b=AcrSelectionUtils.addPropertiesToMatches(b,this.currentHtmlChecking),c=AcrSelectionUtils.findAllFlagOffsets(f,b[0].searchPattern),d=AcrSelectionUtils.findBestMatchOffset(c,b),e=c[d],b[0].foundOffset=e,b[0].content.length>=b[0].range[1]-b[0].range[0]?b[0].textContent=b[0].textContent.replace(/\\/g,""):b[0].textContent=b[0].textContent.replace(/\\\\/g,"\\"),b[0].flagLength=b[0].textContent.length-1,!(e>=0))throw"Selected flagged content is modified.";this.scrollAndSelect(b)},replaceSelection:function(a){$(this.element).replaceSelectedText(a,"select")},replaceRanges:function(a,b){var c,d=0;try{this.selectMatches(a,b),b[0].foundOffset+b[0].flagLength<this.getCurrentText().length&&(b[0].foundOffset+=d,b[0].flagLength-=d),this.scrollAndSelect(b)}catch(e){return void console.log(e)}c=_.map(b,"replacement").join(""),this.replaceSelection(c)}},a}(),MultiEditorAdapter=function(){var a=function(a){this.config=a,this.adapters=[]};return a.prototype={addSingleAdapter:function(a,b,c){void 0===b&&(b="div"),void 0===c&&(c="acrolinx_integration"+this.adapters.length),this.adapters.push({id:c,adapter:a,wrapper:b})},getWrapperTag:function(a){var b=a.split(" ")[0];return b},extractHTMLForCheck:function(){for(var a=Q.defer(),b=[],c=0;c<this.adapters.length;c++){var d=this.adapters[c];b.push(d.adapter.extractHTMLForCheck())}return Q.all(b).then(_.bind(function(b){for(var c="",d=0;d<this.adapters.length;d++){var e=this.adapters[d],f=this.getWrapperTag(e.wrapper),g="<"+e.wrapper+' id="'+e.id+'">',h=b[d].html,i=g+h+"</"+f+">";e.start=c.length+g.length,e.end=c.length+g.length+h.length,c+=i}this.html=c,console.log(this.html),a.resolve({html:this.html})},this)),a.promise},registerCheckCall:function(a){},registerCheckResult:function(a){return this.checkResult=a,this.adapters.forEach(function(b){b.adapter.registerCheckResult(a)}),[]},selectRanges:function(a,b){var c=this.remapMatches(b);for(var d in c)c[d].adapter.selectRanges(a,c[d].matches)},remapMatches:function(a){for(var b={},c=0;c<a.length;c++){var d=_.clone(a[c]);d.range=_.clone(a[c].range);var e=this.getAdapterForMatch(d);b.hasOwnProperty(e.id)||(b[e.id]={matches:[],adapter:e.adapter}),d.range[0]-=e.start,d.range[1]-=e.start,b[e.id].matches.push(d)}return b},getAdapterForMatch:function(a){for(var b=0;b<this.adapters.length;b++){var c=this.adapters[b];if(a.range[0]>=c.start&&a.range[1]<=c.end)return c}return null},replaceRanges:function(a,b){var c=this.remapMatches(b);for(var d in c)c[d].adapter.replaceRanges(a,c[d].matches)}},a}(),TinyMCEAdapter=function(){var a=function(a){this.config=a,this.editorId=a.editorId,this.editor=null};return a.prototype={getEditor:function(){return null===this.editor&&(this.editor=tinymce.get(this.editorId),console.log("tinymce found",this.editor)),this.editor},getHTML:function(){return this.getEditor().getContent()},getEditorDocument:function(){try{return this.editor.contentDocument}catch(a){throw a}},getCurrentText:function(){try{return rangy.innerText(this.getEditorDocument())}catch(a){throw a}},selectText:function(a,b){var c=this.getEditorDocument(),d=rangy.getSelection(c),e=rangy.createRange(c);return e.moveStart("character",a),e.moveEnd("character",b),d.setSingleRange(e),e},scrollIntoView2:function(a){var b=a.getRng(),c=b.cloneRange();c.collapse();var d=document.createElement("span");c.startContainer.parentNode.insertBefore(d,c.startContainer),d.scrollIntoView(),d.remove()},scrollAndSelect:function(a){var b,c,d,e,f;if(b=a[0].foundOffset,c=a[0].flagLength+1,e=this.selectText(b,c),d=this.getEditor().selection)try{this.scrollIntoView2(d);var g=$("#wp-content-editor-container");g.length>0&&g.get(0).scrollIntoView()}catch(h){console.log("Scrolling Error!")}f=this.selectText(b,c)},extractHTMLForCheck:function(){return this.html=this.getHTML(),this.currentHtmlChecking=this.html,{html:this.html}},registerCheckCall:function(a){},registerCheckResult:function(a){return this.isCheckingNow=!1,this.currentHtmlChecking=this.html,this.prevCheckedHtml=this.currentHtmlChecking,[]},selectRanges:function(a,b){this.selectMatches(a,b)},selectMatches:function(a,b){var c,d,e,f=this.getCurrentText();if(b=AcrSelectionUtils.addPropertiesToMatches(b,this.currentHtmlChecking),c=AcrSelectionUtils.findAllFlagOffsets(f,b[0].searchPattern),d=AcrSelectionUtils.findBestMatchOffset(c,b),e=c[d],b[0].foundOffset=e,b[0].content.length>=b[0].range[1]-b[0].range[0]?b[0].textContent=b[0].textContent.replace(/\\/g,""):b[0].textContent=b[0].textContent.replace(/\\\\/g,"\\"),b[0].flagLength=b[0].textContent.length-1,!(e>=0))throw"Selected flagged content is modified.";this.scrollAndSelect(b)},replaceRanges:function(a,b){var c,d=1;try{this.selectMatches(a,b),b[0].foundOffset+b[0].flagLength<this.getCurrentText().length&&(b[0].foundOffset+=d,b[0].flagLength-=d),this.scrollAndSelect(b)}catch(e){return void console.log(e)}c=_.map(b,"replacement").join(""),this.editor.selection.setContent(c),b[0].foundOffset+b[0].flagLength<this.getCurrentText().length&&(d>0&&(this.selectText(b[0].foundOffset-d,d),rangy.getSelection(this.getEditorDocument()).nativeSelection.deleteFromDocument()),b[0].foundOffset-=d,b[0].flagLength+=d),this.selectText(b[0].foundOffset,c.length)}},a}(),SimpleTextAdapter=function(){var a=function(a){this.config=a};return a.prototype={selectText:function(a,b){var c=this.getEditorElement(),d=rangy.createRange();d.setStart(c,0),d.setEnd(c,0),d.moveStart("character",a),d.moveEnd("character",b);var e=rangy.getSelection();e.setSingleRange(d)},findRangesPositionInPlainText:function(a,b){var c=b.map(function(a){return a.content}).join(""),d=a.indexOf(c);return d>-1?{start:d,length:c.length}:null},getEditor:function(){return document.getElementById(this.config.editorId)},getEditorElement:function(){return this.getEditor()},getCurrentText:function(){return rangy.innerText(this.getEditorElement())},getHTML:function(){return this.getEditor().innerHTML},extractHTMLForCheck:function(){return{html:this.getHTML()}},registerCheckCall:function(a){},registerCheckResult:function(a){return[]},selectRanges:function(a,b){var c=this.findRangesPositionInPlainText(this.getCurrentText(),b);c?this.selectText(c.start,c.length):window.alert("Sorry, but I can't select this issue.")},replaceRanges:function(a,b){this.selectRanges(a,b);var c=b.map(function(a){return a.replacement}).join(""),d=rangy.getSelection(),e=d.getRangeAt(0);e.deleteContents();var f=e.createContextualFragment(c);e.insertNode(f)}},a}(),AcrolinxPlugin=function(){function a(a,c){function d(){function c(){void 0!==a.requestAccessTokenCallback?a.requestAccessTokenCallback(function(c){h.acrolinxSidebar.init(_.extend({clientComponents:a.clientComponents||b,token:c,contentPieceUuid:a.documentId},a))}):h.acrolinxSidebar.init(_.extend({clientComponents:a.clientComponents||b},a))}function d(){h.acrolinxSidebar.init({clientComponents:a.clientComponents||b,clientSignature:a.clientSignature,showServerSelector:a.hasOwnProperty("showServerSelector")?a.showServerSelector:!0,serverAddress:a.serverAddress})}console.log("Install acrolinxPlugin in sidebar."),h.acrolinxPlugin={requestInit:function(){console.log("requestInit"),"CLOUD"===a.sidebarType?c():d()},onInitFinished:function(a){console.log("onInitFinished: ",a),a.error&&window.alert(a.error.message)},configure:function(a){console.log("configure: ",a)},requestAccessToken:function(){var b=a.requestAccessTokenCallback;b&&b(function(a){h.acrolinxSidebar.setAccessToken(a)})},requestGlobalCheckSync:function(a,b,c){if(a.hasOwnProperty("error"))window.alert(a.error);else{var d=h.acrolinxSidebar.checkGlobal(a.html,{inputFormat:b||"HTML",requestDescription:{documentReference:c||"filename.html"}});i.registerCheckCall(d)}},requestGlobalCheck:function(){console.log("requestGlobalCheck");var a=i.extractHTMLForCheck(),b=i.getFormat?i.getFormat():null,c=i.getDocumentReference?i.getDocumentReference():null;if(void 0!==a.then){var d=this;a.then(function(a){d.requestGlobalCheckSync(a,b,c)})}else this.requestGlobalCheckSync(a,b,c)},onCheckResult:function(a){return i.registerCheckResult(a)},selectRanges:function(a,b){console.log("selectRanges: ",a,b),i.selectRanges(a,b)},replaceRanges:function(a,b){console.log("replaceRanges: ",a,b),i.replaceRanges(a,b)},getRangesOrder:function(a){return console.log("getRangesOrder: ",a),[]},download:function(a){console.log("download: ",a.url,a),window.open(a.url)},verifyRanges:function(a){return console.log("verifyRanges: ",a),[]},disposeCheck:function(a){console.log("disposeCheck: ",a)}}}function e(){var b;return b=void 0!==a.sidebarUrl?a.sidebarUrl:"CLOUD"===a.sidebarType?"https://acrolinx-integrations.acrolinx-cloud.com/sidebar/v13/":"https://acrolinx-sidebar-classic.s3.amazonaws.com/v13/prod/",$.ajax({url:b+"index.html"}).then(function(a){var c=a.replace(/src="/g,'src="'+b).replace(/href="/g,'href="'+b);h.document.open(),h.document.write(c),h.document.close(),d()})}var f=$("#"+a.sidebarContainerId),g=$("<iframe></iframe>");f.append(g);var h=g.get(0).contentWindow,i=c;e()}var b=[{id:"com.acrolinx.sidebarexample",name:"Acrolinx Sidebar Example Client",version:"1.2.3.999",category:"MAIN"}],c=function(a){this.config=a};return c.prototype={registerAdapter:function(a){this.adapter=a},init:function(){a(this.config,this.adapter)}},c}();
//# sourceMappingURL=acrolinx-sidebar-integration.min.js.map